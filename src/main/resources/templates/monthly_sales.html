<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>Monthly Sales</title></head>
<body>
<h2 th:text="'Monthly Sales - ' + ${ym}">Monthly Sales</h2>

<p>
  <a th:href="@{'/reports/sales/monthly.pdf'(year=${ym.year}, month=${ym.monthValue})}">Download PDF</a>
</p>

<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;min-width:900px;">
  <thead>
  <tr>
    <th>Product</th>
    <th>Qty</th>
    <th>Net</th>
    <th>VAT (13%)</th>
    <th>Gross</th>
    <th>Avg Price</th>
    <th>Unit Cost</th>
    <th>Profit / Loss</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="r : ${rows}">
    <td th:text="${r.productName}">name</td>
    <td th:text="${r.qty}">0</td>
    <td th:text="${#numbers.formatDecimal(r.net, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td th:text="${#numbers.formatDecimal(r.vat, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td th:text="${#numbers.formatDecimal(r.gross, 1, 'POINT', 2, 'POINT')}">0.00</td>

    <!-- Avg Price = net / qty -->
    <td th:text="${
          (r.qty!=null && r.qty>0 && r.net!=null)
          ? #numbers.formatDecimal(r.net / r.qty, 1, 'POINT', 2, 'POINT')
          : '0.00'}">0.00</td>

    <!-- Actual Unit Cost (from product.actualPrice fallback price) -->
    <td th:text="${r.actualUnitCost!=null ? #numbers.formatDecimal(r.actualUnitCost, 1, 'POINT', 2, 'POINT') : '-'}">-</td>

    <!-- Profit/Loss with color and % -->
    <td>
      <span th:with="
              pl=${r.profitLoss!=null ? r.profitLoss : 0},
              avg=${(r.qty!=null && r.qty>0 && r.net!=null) ? (r.net / r.qty) : 0},
              cost=${r.actualUnitCost!=null ? r.actualUnitCost : 0},
              marginPct=${avg>0 ? ((avg-cost)/avg)*100 : 0}
            "
            th:classappend="${pl>=0} ? 'pl-pos' : 'pl-neg' "
            th:text="${#numbers.formatDecimal(pl, 1, 'POINT', 2, 'POINT')}">0.00</span>
      <small style="opacity:.8" th:if="${r.actualUnitCost!=null}">
        (<span th:text="${#numbers.formatDecimal(marginPct, 1, 'POINT', 1, 'POINT')}">0.0</span>%)
      </small>
    </td>
  </tr>
  </tbody>

  <!-- Totals -->
  <tfoot>
  <tr style="font-weight:bold;background:#fafafa;">
    <td>Total</td>
    <td th:text="${totalQty}">0</td>
    <td th:text="${#numbers.formatDecimal(totalNet, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td th:text="${#numbers.formatDecimal(totalVat, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td th:text="${#numbers.formatDecimal(totalGross, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td th:text="${#numbers.formatDecimal(avgPriceOverall, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td th:text="${#numbers.formatDecimal(avgCostOverall, 1, 'POINT', 2, 'POINT')}">0.00</td>
    <td>
      <span th:classappend="${totalPL>=0} ? 'pl-pos' : 'pl-neg'"
            th:text="${#numbers.formatDecimal(totalPL, 1, 'POINT', 2, 'POINT')}">0.00</span>
    </td>
  </tr>
  </tfoot>
</table>

<style>
  .pl-pos { color: #137333; font-weight: 600; } /* green */
  .pl-neg { color: #c5221f; font-weight: 600; } /* red */
</style>
</body>
</html>
