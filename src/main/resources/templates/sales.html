<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Sales</title>

  <!-- Fonts + Bootstrap + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root {
      --radius: 14px;
      --soft-shadow: 0 10px 28px rgba(0,0,0,.08);
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,#f5f7fa 0%,#eef2f7 100%);
      color: #111827;
    }
    .page-header {
      border-radius: var(--radius);
      box-shadow: var(--soft-shadow);
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.8);
      backdrop-filter: blur(6px);
    }
    .card {
      border-radius: var(--radius);
      border: 1px solid rgba(0,0,0,.06);
      box-shadow: var(--soft-shadow);
    }
    .badge-soft {
      background: #eef2ff; color: #1d4ed8; border: 1px solid #dbeafe;
      border-radius: 999px;
    }
    .table thead th {
      text-transform: uppercase;
      letter-spacing: .04em;
      font-size: .78rem;
      color: #64748b;
      background: #f8fafc;
      position: sticky; top: 0; z-index: 1;
    }
    .help-chip {
      font-size:.85rem; border-radius:999px; padding:.15rem .6rem;
      background: rgba(13,110,253,.08); color:#0d6efd;
    }
    .muted { color:#6b7280; }
    .currency { font-variant-numeric: tabular-nums; }
    .form-hint { font-size:.9rem; color:#475569; }
    .empty {
      border:2px dashed #e5e7eb; border-radius: var(--radius);
      background: #fff; padding: 2rem; text-align: center;
      color:#64748b;
    }
    .btn-link {
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="container-xxl py-4">

    <!-- Header -->
    <div class="page-header d-flex align-items-center justify-content-between p-3 mb-4">
      <div class="d-flex align-items-center gap-3">
        <i class="bi bi-receipt-cutoff fs-4 text-primary"></i>
        <div>
          <h4 class="mb-0 fw-semibold">Sales</h4>
          <div class="small text-secondary">Record a new sale and view history</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a th:href="@{/dashboard}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left-short me-1"></i> Dashboard
        </a>
        <a th:href="@{/customers}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-people me-1"></i> Customers
        </a>
      </div>
    </div>

    <div class="card-body">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h6 class="mb-0">Add New Sale</h6>
    <span class="help-chip"><i class="bi bi-info-circle me-1"></i>stock & price update live</span>
  </div>

  <!-- Flash messages (unchanged) -->
  <div th:if="${success}" class="alert alert-success d-flex align-items-center py-2">
    <i class="bi bi-check-circle me-2"></i>
    <span th:text="${success}"></span>
  </div>
  <div th:if="${error}" class="alert alert-danger d-flex align-items-center py-2">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span th:text="${error}"></span>
  </div>

  <form th:action="@{/sales/add}" th:object="${sale}" method="post" class="needs-validation" novalidate>
    <!-- Customer -->
    <div class="mb-3">
      <label for="customer" class="form-label fw-semibold">Customer</label>
      <select id="customer" class="form-select" th:field="*{customer.id}" required>
        <option value="">-- Select Customer --</option>
        <option th:each="cust : ${customers}" th:value="${cust.id}" th:text="${cust.name}"></option>
      </select>
      <div class="invalid-feedback">Please choose a customer.</div>
    </div>

    <!-- Product -->
    <div class="mb-3">
      <label for="product" class="form-label fw-semibold">Product</label>
      <select id="product" class="form-select" th:field="*{product.id}" required onchange="updateFromProduct()">
        <option value="">-- Select Product --</option>
        <option th:each="prod : ${products}"
                th:value="${prod.id}"
                th:text="${prod.name}"
                th:attr="data-price=${prod.price},data-stock=${prod.quantity},data-cost=${prod.actualPrice}">
        </option>
      </select>
      <div class="form-text form-hint" id="productHint">Select a product to see stock, show price & cost.</div>
      <div class="invalid-feedback">Please choose a product.</div>
    </div>

    <!-- Qty + Selling Price row -->
    <div class="row g-3">
      <div class="col-6">
        <label for="quantity" class="form-label fw-semibold">Quantity</label>
        <input id="quantity" type="number" class="form-control" th:field="*{quantity}" min="1" required oninput="recalc()" />
        <div class="invalid-feedback" id="qtyInvalid">Please enter a valid quantity.</div>
      </div>

      <div class="col-6">
        <label for="unitSellingPrice" class="form-label fw-semibold">Selling Price (per unit)</label>
        <!-- bind to new field -->
        <input id="unitSellingPrice" type="number" step="0.01" min="0" class="form-control"
               th:field="*{unitSellingPrice}" required oninput="recalc()"/>
        <div class="form-text">Prefilled from show price — you can discount or mark up.</div>
        <div class="invalid-feedback">Please provide a selling price.</div>
      </div>
    </div>

    <!-- Live totals + margin -->
    <div class="mt-3 p-2 rounded border small">
      <div class="d-flex justify-content-between">
        <span>Stock:</span>
        <span id="stockBadge" class="fw-semibold">-</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Show Price:</span>
        <span id="showPriceBadge" class="fw-semibold">-</span>
      </div>
      <div class="d-flex justify-content-between" th:if="${true}">
        <span>Actual Cost (per unit):</span>
        <span id="costBadge" class="fw-semibold">-</span>
      </div>
      <hr class="my-2"/>
      <div class="d-flex justify-content-between">
        <span>Net Total (excl. VAT):</span>
        <span id="netTotal" class="fw-bold">0.00</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Estimated VAT (13%):</span>
        <span id="vatTotal">0.00</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Gross (incl. VAT):</span>
        <span id="grossTotal">0.00</span>
      </div>
      <div class="d-flex justify-content-between mt-2">
        <span>Margin per unit:</span>
        <span id="marginPerUnit" class="fw-semibold">-</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Total Profit/Loss:</span>
        <span id="totalProfitLoss" class="fw-semibold">-</span>
      </div>
    </div>

    <div class="d-flex align-items-center justify-content-between mt-3">
      <a th:href="@{/customers/add}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-person-plus me-1"></i> Add Customer
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-bag-check me-1"></i> Add Sale
      </button>
    </div>
  </form>
</div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Format INR on the hint nicely
    const fmtINR = n => '₹' + Number(n ?? 0).toLocaleString('en-IN');

    function updateProductHint(){
      const sel = document.getElementById('product');
      const opt = sel.options[sel.selectedIndex];
      const price = opt?.getAttribute('data-price');
      const stock = opt?.getAttribute('data-stock');
      const hint = document.getElementById('productHint');

      if (!price && !stock){
        hint.textContent = 'Select a product to see unit price & stock.';
        return;
      }
      hint.innerHTML = `
        <span class="me-3"><i class="bi bi-tag"></i> Unit Price: <b>${fmtINR(price || 0)}</b></span>
        <span><i class="bi bi-box-seam"></i> In Stock: <b>${stock ?? 0}</b></span>
      `;

      // Re-validate quantity if already filled
      validateQty();
    }

    function validateQty(){
      const qtyEl = document.getElementById('quantity');
      const productEl = document.getElementById('product');
      const opt = productEl.options[productEl.selectedIndex];
      const stock = parseInt(opt?.getAttribute('data-stock') || '0', 10);
      const qty = parseInt(qtyEl.value || '0', 10);
      const invalidMsg = document.getElementById('qtyInvalid');

      // Basic HTML5 required/min handles 0/empty; we add stock ceiling
      if (qty > 0 && stock >= 0 && qty > stock){
        qtyEl.setCustomValidity('Quantity exceeds available stock');
        invalidMsg.textContent = `Quantity exceeds available stock (${stock}).`;
      } else {
        qtyEl.setCustomValidity('');
        invalidMsg.textContent = 'Please enter a valid quantity.';
      }
    }

    // Bootstrap validation styling
    (function () {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          updateProductHint(); // ensure latest
          validateQty();
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();
  </script>
</body>
</html>
