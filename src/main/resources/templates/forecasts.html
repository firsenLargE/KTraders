<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Demand Forecasting - Kapil Traders</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary:#1e40af; --primary-light:#3b82f6; --success:#16a34a; --warning:#f59e0b;
      --danger:#dc2626; --info:#0ea5e9; --background:#f8fafc; --white:#fff;
      --text-dark:#1e293b; --text-light:#64748b; --border:#e2e8f0;
      --shadow:0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:var(--background);color:var(--text-dark);line-height:1.6;padding:24px}

    .header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);color:#fff;padding:32px;border-radius:16px;margin-bottom:32px;box-shadow:var(--shadow-lg)}
    .header h1{font-size:2.2rem;font-weight:700;margin-bottom:8px}
    .header p{opacity:.9;margin-bottom:20px}
    .header-actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
    .btn-primary{background:#fff;color:var(--primary)}
    .btn-success{background:var(--success);color:#fff}
    .btn .icon{font-style:normal}
    .btn-back .icon{content:"‚Üê"}
    .btn-generate .icon{content:"‚ö°"}

    .alert{padding:14px 16px;border-radius:12px;margin:18px 0;display:flex;gap:10px;align-items:center;font-weight:500}
    .alert-success{background:#f0fdf4;color:#15803d;border-left:4px solid var(--success)}
    .alert-error{background:#fef2f2;color:#dc2626;border-left:4px solid var(--danger)}

    .forecast-chart{background:var(--white);border-radius:16px;padding:24px;box-shadow:var(--shadow);margin-bottom:24px;border:1px solid var(--border)}
    .chart-title{font-size:1.2rem;font-weight:600}

    .forecast-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:20px;margin-top:24px}
    @media (max-width:1200px){.forecast-grid{grid-template-columns:1fr}}
    .product-forecast-card{grid-column:span 6;background:var(--white);border-radius:16px;padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);animation:fadeIn .4s ease}
    @media (max-width:1200px){.product-forecast-card{grid-column:span 12}}
    .product-forecast-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
    .product-header{display:flex;justify-content:space-between;gap:16px;margin-bottom:16px}
    .product-info h3{font-size:1.2rem;font-weight:600;margin-bottom:4px}
    .product-meta{display:flex;gap:10px;flex-wrap:wrap}
    .product-tag{padding:4px 10px;border-radius:999px;font-size:.78rem;font-weight:600}
    .tag-category{background:#ede9fe;color:#7c3aed}
    .tag-price{background:#fef3c7;color:#d97706}
    .tag-stock{background:#ecfdf5;color:#059669}
    .tag-low-stock{background:#fee2e2;color:#dc2626}
    .current-stock{text-align:right}
    .stock-number{font-size:1.6rem;font-weight:700;color:var(--primary)}
    .stock-label{font-size:.8rem;color:var(--text-light);text-transform:uppercase}

    table.forecast-table{width:100%;border-collapse:collapse;margin-top:6px}
    .forecast-table th{background:#f8fafc;color:var(--text-dark);font-weight:700;padding:10px 12px;text-align:left;font-size:.8rem;text-transform:uppercase;border-bottom:2px solid var(--border)}
    .forecast-table td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    .forecast-table tbody tr:hover{background:#f9fafb}

    .season-badge{padding:6px 10px;border-radius:12px;font-size:.75rem;font-weight:700;letter-spacing:.3px;display:inline-flex;gap:6px;align-items:center;text-transform:uppercase}
    .season-spring{background:#f0fdf4;color:#166534}.season-summer{background:#fefce8;color:#ca8a04}
    .season-autumn{background:#fff7ed;color:#ea580c}.season-winter{background:#f1f5f9;color:#475569}
    .season-spring::before{content:"üå∏"}.season-summer::before{content:"‚òÄÔ∏è"}.season-autumn::before{content:"üçÇ"}.season-winter::before{content:"‚ùÑÔ∏è"}
    .demand-prediction{font-weight:700;color:var(--primary)}
    .confidence-meter{position:relative;width:90px;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
    .confidence-fill{height:100%;border-radius:4px;transition:width .25s ease}
    .confidence-high{background:linear-gradient(90deg,#10b981,#059669)}
    .confidence-medium{background:linear-gradient(90deg,#f59e0b,#d97706)}
    .confidence-low{background:linear-gradient(90deg,#ef4444,#dc2626)}
    .confidence-text{font-size:.82rem;font-weight:600;margin-top:4px}

    .empty{border:2px dashed #e5e7eb;border-radius:14px;background:#fff;padding:18px;text-align:center;color:#64748b;margin-top:14px}

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>üîÆ AI Demand Forecasting</h1>
    <p>Advanced predictive analytics for inventory management powered by seasonal patterns and historical data.</p>
    <div class="header-actions">
      <a th:href="@{/dashboard}" class="btn btn-primary btn-back"><span class="icon">‚Üê</span> Dashboard</a>
      <form th:action="@{/forecasts/generate-all}" method="post" style="display:inline;">
        <button type="submit" class="btn btn-success btn-generate"><span class="icon">‚ö°</span> Generate All Forecasts</button>
      </form>
    </div>
  </div>

  <!-- Flash messages -->
  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
  <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

  <!-- Overview Chart -->
  <div class="forecast-chart" th:if="${!#lists.isEmpty(products)}">
    <div class="chart-title">üìà Demand Forecast Overview</div>
    <div style="position:relative;height:380px;margin-top:10px">
      <canvas id="forecastOverviewChart"></canvas>
    </div>
  </div>

  <!-- No products -->
  <div th:if="${#lists.isEmpty(products)}" class="empty" style="padding:48px">
    <div style="font-size:3rem;margin-bottom:8px">üì¶</div>
    <h3 style="margin-bottom:6px">No Products Found</h3>
    <p style="margin-bottom:16px">Add products to start generating demand forecasts.</p>
    <a th:href="@{/add-product}" class="btn btn-primary">Add Products</a>
  </div>

  <!-- Product Forecast Cards -->
  <div class="forecast-grid" th:if="${!#lists.isEmpty(products)}">
    <div class="product-forecast-card" th:each="product : ${products}">
      <div class="product-header">
        <div class="product-info">
          <h3 th:text="${product.name}">Product Name</h3>
          <div class="product-meta">
            <span class="product-tag tag-category" th:text="${product.category} ?: '‚Äî'">Category</span>
            <span class="product-tag tag-price"
                  th:text="'‚Çπ' + ${#numbers.formatDecimal(product.price, 0, 2)}">‚Çπ0.00</span>
            <span class="product-tag"
                  th:class="${product.quantity} < 10 ? 'product-tag tag-low-stock' : 'product-tag tag-stock'"
                  th:text="${product.quantity} + ' units'">0 units</span>
          </div>
          <div style="color:var(--text-light);font-size:.9rem" th:text="${product.size} ? ${'Size: ' + product.size} : 'Size: ‚Äî'">Size</div>
        </div>
        <div class="current-stock">
          <div class="stock-number" th:text="${product.quantity}">0</div>
          <div class="stock-label">Current Stock</div>
        </div>
      </div>

      <!-- Forecast table present -->
      <div th:if="${productForecasts[product.id] != null and !#lists.isEmpty(productForecasts[product.id])}">
        <table class="forecast-table">
          <thead>
          <tr>
            <th>üìÖ Period</th>
            <th>üåç Season</th>
            <th>üìä Predicted</th>
            <th>üéØ Confidence</th>
            <th>üîß Method</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="forecast : ${productForecasts[product.id]}">
            <td class="forecast-period" th:text="${#temporals.format(forecast.forecastFor, 'MMMM yyyy')}">Month YYYY</td>
            <td>
              <span class="season-badge"
                    th:class="'season-badge season-' + ${forecast.season.toLowerCase()}"
                    th:text="${forecast.season}">SEASON</span>
            </td>
            <td><span class="demand-prediction" th:text="${forecast.predictedDemand} + ' units'">0 units</span></td>
            <td>
              <div class="confidence-meter">
                <div class="confidence-fill"
                     th:style="'width:' + (${forecast.confidence} * 100) + '%'"
                     th:class="${forecast.confidence} >= 0.8 ? 'confidence-fill confidence-high' :
                               (${forecast.confidence} >= 0.6 ? 'confidence-fill confidence-medium' :
                                                                'confidence-fill confidence-low')"></div>
              </div>
              <div class="confidence-text"
                   th:text="${#numbers.formatDecimal(forecast.confidence * 100, 0, 0)} + '%'">0%</div>
            </td>
            <td><span class="method-badge" th:text="${forecast.method}">METHOD</span></td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- No forecasts yet for this product -->
      <div th:unless="${productForecasts[product.id] != null and !#lists.isEmpty(productForecasts[product.id])}" class="empty">
        <div style="font-size:1.6rem;margin-bottom:6px">üìä</div>
        <div style="font-weight:700;margin-bottom:4px">No Forecast Available</div>
        <div style="margin-bottom:10px;color:var(--text-light)">Generate forecasts to see demand predictions.</div>
        <form th:action="@{/forecasts/generate/{productId}(productId=${product.id})}" method="post" style="display:inline">
          <button type="submit" class="btn btn-success btn-generate"><span class="icon">‚ö°</span> Generate Forecast</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Chart + UX scripts -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    // Build Overview chart from Thymeleaf data
    const PRODUCTS = /*[[${products}]]*/ [];
    const PF = /*[[${productForecasts}]]*/ {};

    const labels = [];
    const predicted = [];
    const stock = [];

    PRODUCTS.forEach(p => {
      const arr = PF[p.id] || [];
      if (arr.length > 0) {
        labels.push(p.name);
        const avg = Math.round(arr.reduce((s,f)=>s+(f.predictedDemand||0),0) / arr.length);
        predicted.push(avg);
        stock.push(p.quantity || 0);
      }
    });

    if (labels.length > 0) {
      const ctx = document.getElementById('forecastOverviewChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Predicted Demand',
              data: predicted,
              borderColor: 'rgba(30,64,175,0.9)',
              backgroundColor: 'rgba(30,64,175,0.12)',
              borderWidth: 3, tension: 0.35, fill: true,
              pointBackgroundColor: 'rgba(30,64,175,1)', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 5
            },
            {
              label: 'Current Stock',
              data: stock,
              borderColor: 'rgba(34,197,94,0.9)',
              backgroundColor: 'rgba(34,197,94,0.12)',
              borderWidth: 3, tension: 0.35, fill: true,
              pointBackgroundColor: 'rgba(34,197,94,1)', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 5
            }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{position:'top', labels:{usePointStyle:true,padding:16}},
            tooltip:{
              mode:'index', intersect:false,
              callbacks:{
                afterLabel(ctx){
                  if(ctx.datasetIndex!==0) return '';
                  const idx=ctx.dataIndex; const cur=stock[idx]; const pred=predicted[idx];
                  const diff = cur - pred;
                  if (diff < 0) return ` ‚ö† Stock shortage: ${Math.abs(diff)} units`;
                  if (diff > pred * 0.5) return ` üì¶ Overstock by: ${diff} units`;
                  return ' ‚úÖ Adequate';
                }
              }
            }
          },
          scales:{
            x:{title:{display:true,text:'Products',font:{weight:'bold'}}},
            y:{beginAtZero:true,title:{display:true,text:'Units',font:{weight:'bold'}}}
          }
        }
      });
    }

    // Auto-hide alerts
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(a => {
        a.style.transition='opacity .4s, transform .4s';
        a.style.opacity='0'; a.style.transform='translateX(12px)';
        setTimeout(()=>a.remove(), 400);
      });
    }, 5000);

    // Hover border cue
    document.querySelectorAll('.product-forecast-card').forEach(card=>{
      card.addEventListener('mouseenter',()=>card.style.borderColor='#3b82f6');
      card.addEventListener('mouseleave',()=>card.style.borderColor='#e2e8f0');
    });

    // Loading state on generate buttons
    document.querySelectorAll('form[action*="/forecasts/generate"]').forEach(f=>{
      f.addEventListener('submit', function(){
        const btn=this.querySelector('button[type="submit"]'); if(!btn) return;
        const txt=btn.textContent; btn.disabled=true; btn.textContent='‚è≥ Generating...';
        setTimeout(()=>{btn.disabled=false; btn.textContent=txt;}, 3000);
      });
    });

    // Tooltips for seasons + confidence
    document.querySelectorAll('.season-badge').forEach(b=>{
      const s=(b.textContent||'').trim().toLowerCase();
      const map={spring:'Spring ‚Äî moderate demand', summer:'Summer ‚Äî peak demand', autumn:'Autumn ‚Äî cooling demand', winter:'Winter ‚Äî low demand'};
      b.title = map[s] || 'Seasonal pattern';
      b.style.cursor='help';
    });
    document.querySelectorAll('.confidence-text').forEach(t=>{
      const val = parseFloat((t.textContent||'0').replace('%','')) || 0;
      t.title = val>=80 ? 'High confidence' : (val>=60 ? 'Medium confidence' : 'Low confidence');
      t.style.cursor='help';
    });
    /*]]>*/
  </script>
</body>
</html>
